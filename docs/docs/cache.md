# Cache

## 概述

## 缓存一致性

由于设计的是单核系统，因此可以不将缓存一致性结点设置为内存（强序非缓存区域除外）；

缓存一致性结点为 L1 DCache（即可缓存区 L1 DCache 中的数据始终是最新数据）。对于自修改指令，应先冲刷 L1 DCache，然后冲刷 L1 ICache；

## ICache

阻塞式缓存，请求一定顺序执行。

### 接口

ICache 只支持读取和 CACOP 操作。读取时，一次性返回给定地址 16 字节对齐的 4 条指令。共有 4 个通道：`control (c)`, `read address (ar)`, `read data (r)` 和 `cacop`。

#### `control (c)`

同时控制 `ar` 和 `cacop` 通道的握手信号，优先处理 `cacop` 请求（当 `cacop_en` 为高电平，`ready` 响应的是 `cacop` 通道的请求，阻塞 `ar` 通道）；

| I/O 	| 信号    	| 位宽 	| 含义                                                              	|
|-----	|---------	|------	|-------------------------------------------------------------------	|
| I   	| `valid` 	| 1    	| `ar` 或 `cacop` 通道请求有效；使用者不能依靠 `ready` 生成 `valid` 	|
| O   	| `ready` 	| 1    	| 请求被接受；在 Cache 中，可能会根据 `valid` 生成 `ready`          	|

#### `read address (ar)`

当前，即使是 Uncached 访存，ICache 仍然会从给定 `araddr` 16 字节对齐处连续取出 16 字节返回给上层；

| I/O 	| 信号       	| 位宽 	| 含义                   	|
|-----	|------------	|------	|------------------------	|
| I   	| `araddr`   	| 32   	| PA                     	|
| I   	| `uncached` 	| 1    	| 非缓存(1)<br>可缓存(0) 	|

#### `read data (r)`

当前请求结果返回。

| I/O 	| 信号   	| 位宽 	| 含义                                               	|
|-----	|--------	|------	|----------------------------------------------------	|
| O   	| `rvalid` 	| 1    	| 返回结果有效                                       	|
| O   	| `rdata`  	| 128  	| 从 `araddr & $signed(0xf0)` 位置开始的连续 16 字节 	|

#### `cacop`

| I/O 	| 信号         	| 位宽 	| 含义                                                                                             	|
|-----	|--------------	|------	|--------------------------------------------------------------------------------------------------	|
| I   	| `cacop_code` 	| 2    	| 即 `cacop` 指令中的 `code[4:3]`                                                                  	|
| I   	| `cacop_addr` 	| 32   	| 即 `cacop` 指令使用的地址，如果是 `code[4:3] == 2` （查表命中则无效）的情况，该地址已经转换为 PA 	|

### 版本

#### `icache_dummy`

读操作均为 Uncached，每次读取都会直接访问总线，采用了最为简单的设计，第一拍寄存请求，第二拍发起总线请求，然后接收持续若干拍，最后一拍将缓存内容和最后一拍的数据合起来返回；

#### `icache_dummy_v2`

能够连续不断地处理请求（虽然都是 Miss），即能够在 `state_receive` 直接处理新请求，虽然不满足全功能 ICache 的时序（至少 1 拍），但由于非缓存时总线延时至少 1 拍，更好地满足了完全非缓存的测试需求；

#### `icache_v2`

第一个接口匹配，功能完善（支持 Uncached 和 CACOP）的 Cache；

大小为 4KB，直接映射，256 行，每行 16 B；

#### `icache_v3`

大小 8KB，2 路组相连，256 行，每行 16B，随机替换；

#### `icache_v4`

大小 8KB，2 路组相连，256 行，每行 16B，LRU 替换；

#### `icache_v5` (WIP)

- 在 `state_lookup` 阶段如果 `hit`，接受新请求，不返回 `state_idle` 再重新接受请求；

    > 直到 `icache_v4` 都有一个问题，即不能连续处理请求，如果在 `state_lookup` 命中情况下应该可以继续留在 `state_lookup`，而不需要回到 `state_idle`；

- 添加性能计数器接口；

## DCache

### 接口

### 版本

#### `dcache_dummy`

#### `dcache_dummy_v2`
