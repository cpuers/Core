# CPU

## 概述

## 各阶段概述

### 取指阶段

- 为了充分利用icache的性能,我们将取指分为两个阶段，第一阶段负责向icache发送取指请求并由bpu计算下一个周期取指的地址，每次取指可以取出从`PC & 0xFFFFFFF0` 为首地址的四条指令. 第二阶段负责接收从icache取出的指令, 由于取出的四条指令中可能存在重复取指的情况, 因此需要在这个阶段将去除掉无效的指令再将其送入InstrBuffer

#### InstrBuffer

- 由于取指的数量由1-4条不等, 而后端发射的指令数量也由0-2条不等, 因此传统的流水线段间寄存器维护逻辑将会非常复杂, 因此我们采用了一个队列来维护取出的指令, 前端只需将取出的地址放入InstrBuff, 后端只需根据buffer是否为空来判断当前取出的指令是否有效即可.采用InstrBuffer的设计 大大减少了取指和发射之间交互逻辑的复杂程度,  由于取指速度通常大于后端发射速度, 因此当icache miss的时候Instrbuffer中剩余的指令也可以继续填充流水线, 避免不必要的空转. 

### id阶段

- 此阶段由两个子译码器和一个发射判断器件组成, 其负责向产生译码信号,译码器的设计参考《CPU设计实战》一书所提供的示例代码， 并根据译码结果判断是否能够进行双发射，其中不能够双发的情况如下：

    - 第一条指令是跳转指令或存在例外，那么后续一条指令可能不应该被执行，因此只能单发
    - 第一条指令和第二条指令发生RAW冒险
    - 第一条指令和第二条指令均为访存指令/乘法指令/除法指令， 由于这些这些运算部件只有一个， 因此必须单发射
    - 第一条是load/store指令， 由于load/store指令可能会触发例外，从而变成一种特殊的跳转指令，因此也只能单发射
    - 第一条指令根本不是跳转指令，但被BPU错误的认为是跳转指令且发生跳转，那么后续一条指令是无效指令，需要单发并冲刷流水线
- exm阶段

- 此阶段整合了EXE阶段和MEM阶段，通过对指令的判断选择相应的执行部件fu结果:
    - alu:进行一般算术和逻辑运算
    
    - agu:用于访问内存（通过cache）
    
    - branchcond:进行跳转处理，判断分支预测是否正确，处理分支预测错误的情况
    
    - 乘除法器:进行乘除法运算
  
- 其主要接口如下:

    | Input/Output | 名称               | 作用                                            |
    | ------------ | ------------------ | ----------------------------------------------- |
    | I            | clk                | 时钟信号                                        |
    | I            | reset              | 复位信号                                        |
    | I            | ws_allowin         | WB阶段握手信号，表示WB阶段是否空闲，高电平有效      |
    | O            | es_allowin         | EXM阶段握手信号, 表示EXE阶段是否空闲,高电平有效     |
    | I            | ds_to_es_valid     | ID向EXM阶段传递的数据是否有效,高电平有效            |
    | I            | ds_to_es_bus       | ID向EXM阶段传递的指令数据                         |
    | I            | forward_data1      | 第一条EXM段流水线的旁路信息,解决RAW问题            |
    | I            | forward_data2      | 第二条EXM段流水线的旁路信息,解决RAW问题            |
    | O            | exm_forward_bus    | 该流水线的给下一周期指令的旁路信息                 |
    | O            | br_bus             | 分支预测失败的前转的正确跳转信息                   |
    | O            | flush_IF           | 冲刷IF流水线段，高电平有效                        |
    | O            | flush_ID           | 冲刷ID流水线段，高电平有效                        |
    | O            | es_to_ws_valid     | EXM向WB阶段传递的数据是否有效,高电平有效           |
    | O            | es_to_ws_bus       | EXM向WB阶段传递的指令数据                        |
    | I            | dcache_rdata_bus   | dcache中读取的信息                               |
    | O            | dcache_wdata_bus   | 写入dcache的信息                                 |


### wb阶段
- 此阶段进行计算结果到寄存器的写入

- 其主要接口如下:

    | Input/Output | 名称               | 作用                                            |
    | ------------ | ------------------ | ----------------------------------------------- |
    | I            | clk                | 时钟信号                                        |
    | I            | reset              | 复位信号                                        |
    | O            | ws_allowin         | WB阶段握手信号，表示WB阶段是否空闲，高电平有效      |
    | I            | es_to_ws_valid1    |第一条EXM段传递的数据是否有效,高电平有效            |
    | I            | es_to_ws_valid2    | 第一条EXM段传递的数据是否有效,高电平有效           |
    | I            | es_to_ws_bus1      | 第一条EXM段传递的数据                            |
    | I            | es_to_ws_bus2      | 第二条EXM段传递的数据                            |
    | O            | ws_to_rf_bus       | 写入寄存器的信息                                 |

## 版本迭代

| 组件                                      	| 频率 	| GS132     	| OpenLA500 	|
|-------------------------------------------	|------	|-----------	|-----------	|
| 流水线                                    	| 60M  	| 2.819054  	| 0.101638  	|
| ICache                                    	| 58M  	| 6.116530  	| 0.220525  	|
| I/DCache                                  	| 60M  	| 39.312951 	| 1.417398  	|
| I/DCache<br>+ BPU<br>“稳定版”[^1]             	| 55M  	| 44.714932 	| 1.612147  	|
| I/DCache<br>+ BPU<br>“降频版”<br>（最终）[^2] 	| 50M  	| 40.917818 	| 1.475246  	|

[^1]: 频率为 55Mhz 时，在各个组员电脑上/多次综合，结果不一定时序违例；
[^2]: 保险起见，降频到 50Mhz;


## 主要功能部件性能指标

|                 	| bitcount 	| bubble_sort 	| coremark 	| stream_copy 	| quick_sort 	|
|-----------------	|----------	|-------------	|----------	|-------------	|------------	|
| BPU             	| 79%      	| 78%         	| 76%      	| 87%         	| 63%        	|
| 单发率          	| 33%      	| 94%         	| 59%      	| 57%         	| 65%        	|
| ICache          	| 98%      	| 99.8%       	| 98.5%    	| 96%         	| 99%        	|
| DCache<br>Load  	| 98%      	| 99.7%       	| 99.8%    	| 92%         	| 96%        	|
| DCache<br>Store 	| 84%      	| 98.9%       	| 96%      	| 69%         	| 95%        	|
