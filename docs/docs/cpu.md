# CPU

## 概述

## 各阶段概述

### 取指阶段

- 为了充分利用icache的性能,我们将取指分为两个阶段，第一阶段负责向icache发送取指请求并由bpu计算下一个周期取指的地址，每次取指可以取出从`PC & 0xFFFFFFF0` 为首地址的四条指令. bpu会给出该周期指令组的有效情况和跳转情况。第二阶段负责接收从icache取出的指令, 由于取出的四条指令中可能存在重复取指的情况, 因此需要在这个阶段将去除掉无效的指令再将其送入InstrBuffer

#### InstrBuffer

- 由于取指的数量由1-4条不等, 而后端发射的指令数量也由0-2条不等, 因此传统的流水线段间寄存器维护逻辑将会非常复杂, 因此我们采用了一个队列来维护取出的指令, 前端只需将取出的地址放入InstrBuff, 后端只需根据buffer是否为空来判断当前取出的指令是否有效即可.采用InstrBuffer的设计 大大减少了取指和发射之间交互逻辑的复杂程度,  由于取指速度通常大于后端发射速度, 因此当icache miss的时候Instrbuffer中剩余的指令也可以继续填充流水线, 避免不必要的空转. 

### id阶段

- 此阶段由两个子译码器和一个发射判断器件组成, 其负责向产生译码信号,译码器的设计参考《CPU设计实战》一书所提供的示例代码， 并根据译码结果判断是否能够进行双发射，其中不能够双发的情况如下：

    - 第一条指令是跳转指令或存在例外，那么后续一条指令可能不应该被执行，因此只能单发
    - 第一条指令和第二条指令发生RAW冒险
    - 第一条指令和第二条指令均为访存指令/乘法指令/除法指令， 由于这些这些运算部件只有一个， 因此必须单发射
    - 第一条是load/store指令， 由于load/store指令可能会触发例外，从而变成一种特殊的跳转指令，因此也只能单发射
    - 第一条指令根本不是跳转指令，但被BPU错误的认为是跳转指令且发生跳转，那么后续一条指令是无效指令，需要单发并冲刷流水线


### exm阶段

- 此阶段整合了EXE阶段和MEM阶段，根据译码阶段的数据对指令运算类型进行判断，选择四种相应的执行部件FU的运算结果。

    - 对于算术指令，使用ALU进行一般算术和逻辑运算。
    
    - 对于乘除法算术指令，使用仲裁选择两条执行路径上的有效指令，IP核进行乘法运算，xxx进行除法运算。

    - 对于分支指令，判断方向预测是否成功，并将实际目标地址和跳转信息送回BPU单元。

    - 对于访存指令，使用仲裁选择两条执行路径上的有效访存指令，发送给AGU单元进行与dcache的通信。

    - 对于特殊指令，如csr处理指令，发送读请求获取csr数据。
  
  当两条执行流水线段中的一条在处理需要阻塞的指令（访存、乘除法），另一条流水线需等待直至两条指令都处理完成才会发送到提交阶段。

  若同时执行的两条处理指令发生RAW冲突，因为每个FU的操作数只有三个来源：寄存器、自身FU计算结果、另一个FU计算结果。所以可以使用旁路网络进行数据前转。


### wb阶段

- 此阶段进行计算结果到寄存器的写入，寄存器两个写端口支持WB阶段的双发射写回。对于写入同一个地址的写回操作将第一条写使能置零。

- 由于寄存器下降沿写入，不会发生WB和ID的读写冲突，简化数据前转。

## 版本迭代

| 组件                                      	| 频率 	| GS132     	| OpenLA500 	|
|-------------------------------------------	|------	|-----------	|-----------	|
| 流水线                                    	| 60M  	| 2.819054  	| 0.101638  	|
| ICache                                    	| 58M  	| 6.116530  	| 0.220525  	|
| I/DCache                                  	| 60M  	| 39.312951 	| 1.417398  	|
| I/DCache<br>+ BPU<br>“稳定版”[^1]             	| 55M  	| 44.714932 	| 1.612147  	|
| I/DCache<br>+ BPU<br>“降频版”<br>（最终）[^2] 	| 50M  	| 40.917818 	| 1.475246  	|

[^1]: 频率为 55Mhz 时，在各个组员电脑上/多次综合，结果不一定时序违例；
[^2]: 保险起见，降频到 50Mhz;


## 主要功能部件性能指标

|                 	| bitcount 	| bubble_sort 	| coremark 	| stream_copy 	| quick_sort 	|
|-----------------	|----------	|-------------	|----------	|-------------	|------------	|
| BPU             	| 79%      	| 78%         	| 76%      	| 87%         	| 63%        	|
| 单发率          	| 33%      	| 94%         	| 59%      	| 57%         	| 65%        	|
| ICache          	| 98%      	| 99.8%       	| 98.5%    	| 96%         	| 99%        	|
| DCache<br>Load  	| 98%      	| 99.7%       	| 99.8%    	| 92%         	| 96%        	|
| DCache<br>Store 	| 84%      	| 98.9%       	| 96%      	| 69%         	| 95%        	|
