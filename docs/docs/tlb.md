# TLB

## 概述

TLB 的主体是一个多端口 CAM，支持两种寻址方式

- 按 `VPPN` 和 `ASID` 字段为键寻址；
- 按给出的下标 `idx` 寻址；

支持多个读写端口

- 流水线中 IFU 和 LSU 两个端口同时按 CAM 寻址并地址转换；
- 读出或写入给定的 `idx` 所在行；
- `invtlb` 指令的清空操作；

## 时序

为了适配不同的流水段拆分需求，设计了两种 TLB:

- `tlb_async` 类似于寄存器堆，所有读取操作为组合逻辑，当前周期得结果；所有写入为 1 周期；
- `tlb_sync` 类似于 SRAM，地址转换的读取操作分为两步，在第一周期 CAM 寻址得出 `idx`，第二周期用 `idx` 索引存储器；TLB 指令的读取操作仍然为组合逻辑，当前周期得结果；所有写入为 1 周期；

    > 读写顺序是**读后写**，若 (`write` 或 `invtlb`) 和 (`if`, `ls`, `read`) 同时访问同一项（该项的 `idx` 在上升沿来到前已经由组合逻辑确定），则所有读功能的端口获取的是上升沿来到前的数据，不是上升沿时将从写功能口输入的数据，

## 接口

主要有 5 个接口，分别是 

- `translation: ifetch`: IFU 中的地址转换;
- `translation: load / store`: LSU 中的地址转换;
- `read`: 根据给定的 `idx`，读取 TLB 相应行;
- `write`: 根据给定的 `idx`，写入 TLB 相应行;
- `invtlb`: 处理 `INVTLB` 指令;

`tlb_async` 和 `tlb_sync` 的接口信号含义完全一致，只是在输出信号是否延迟一个周期上不同；

`invtlb` 和 `write` 端口不能同时使用，如果出现 `inv_en` 和 `w_en` 同时为高电平，则优先处理 `invtlb` 端口请求；

### translation

| I/O 	| 信号     	| 位宽 	| 含义                                           	|
|-----	|----------	|------	|------------------------------------------------	|
| I   	| `vpn`      	| 20   	| 虚页号，即 VA[31:12]                           	|
| O   	| `unpriv`   	| 1    	| 越权访问，高位有效                             	|
| O   	| `uncached` 	| 1    	| 访存类型是强序非缓存 (1)<br>还是一致可缓存 (0) 	|

### read / write

和 TLB 相关的 CSR 主要有 TLBEHI, TLBLO0/1, ASID。输入和输出信号中 TLBLO0/1 与其直接相连即可（如果 CSR 位域是按照手册的布局），但是 TLB 中应该存储的信息，与 TLBEHI 的布局相比有较大变化，因此是拆开来连接的。

请注意 `r/w_e` 和 `r/w_en` 的区别。
- `r/w_e` 是 CSR TLBEHI 中的字段，或者手册上 TLB 内部布局的 `e` 字段，表示 TLB 表项是否有效；
- `r/w_en` 指读/写端口是否启用；

| I/O 	| 信号    	| 位宽 	| 含义                        	|
|-----	|---------	|------	|-----------------------------	|
| I/O 	| `tlbelo*` 	| 28   	| 同名 CSR 的值，直接连线即可 	|

### invtlb

| I/O 	| 信号     	| 位宽 	| 含义                                    	|
|-----	|----------	|------	|-----------------------------------------	|
| I   	| `inv_en`   	| 1    	| 启用 `invtlb` 端口，优先于 `write` 端口 	|
| I   	| `inv_op`   	| 5    	| 即 `invtlb` 指令中的 `op`               	|
| I   	| `inv_asid` 	| 10   	| CSR `ASID` 中的 `ASID` 字段             	|
| I   	| `inv_vppn` 	| 19   	| 即 `VA[31:13]`                          	|

## 设计
