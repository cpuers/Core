# TLB

## 概述

TLB 的主体是一个多端口 CAM，支持两种寻址方式

- 按 `VPPN` 和 `ASID` 字段为键寻址；
- 按给出的下标 `idx` 寻址；

支持多个读写端口

- 流水线中 IFU 和 LSU 两个端口同时按 CAM 寻址并地址转换；
- 读出或写入给定的 `idx` 所在行；
- `invtlb` 指令的清空操作；

## 时序

为了适配不同的流水段拆分需求，设计了两种 TLB:

- `tlb_async` 所有读取操作为组合逻辑，当前周期得结果；所有写入为 1 周期；
- `tlb_sync` 地址转换的读取操作分为两步，在第一周期 CAM 寻址得出 `idx`，第二周期用 `idx` 索引存储器；TLB 指令的读取操作仍然为组合逻辑，当前周期得结果；所有写入为 1 周期；

## 接口

主要有 5 个接口，分别是 

- `translation: ifetch`: IFU 中的地址转换;
- `translation: load / store`: LSU 中的地址转换;
- `read`: 根据给定的 `idx`，读取 TLB 相应行;
- `write`: 根据给定的 `idx`，写入 TLB 相应行;
- `invtlb`: 处理 `INVTLB` 指令;

`tlb_async` 和 `tlb_sync` 的接口信号含义完全一致，只是在输出信号是否延迟一个周期上不同；

`invtlb` 和 `write` 端口不能同时使用，如果出现 `inv_en` 和 `w_en` 同时为高电平，则优先处理 `invtlb` 端口请求；

### translation

| I/O 	| 信号     	| 位宽 	| 含义                                           	|
|-----	|----------	|------	|------------------------------------------------	|
| I   	| vpn      	| 20   	| 虚页号，即 VA[31:12]                           	|
| O   	| unpriv   	| 1    	| 越权访问，高位有效                             	|
| O   	| uncached 	| 1    	| 访存类型是强序非缓存 (1)<br>还是一致可缓存 (0) 	|

### read / write

| I/O 	| 信号    	| 位宽 	| 含义                        	|
|-----	|---------	|------	|-----------------------------	|
| I/O 	| tlbelo* 	| 28   	| 同名 CSR 的值，直接连线即可 	|

### 
