# BPU

## 概述

在CPU流水线中，取指一条分支指令，若无法预测下一跳指令地址，则其下一条指令被IF阶段取出，只有当分支指令在BranchCond执行单元中运算发现指令无效时发送冲刷信号冲刷流水线。这样不仅造成流水线段的浪费，也消耗周期，污染Icache。

而在LoongArch架构中的指令除BL和JIRL指令均为直接跳转指令，且除JIRL指令外的分支指令跳转地址不变，因此非常适合用缓存存储分支指令的跳转地址。当IF阶段取指将地址发送给BPU，BPU使用组合逻辑在一个周期内将该组指令的有效情况和跳转情况以及下一组指令的第一条指令地址发送回IF阶段，用于下一周期取指令，这个与IF向Icache读取指令阶段可同时执行，对流水线的周期无影响。

无论是间接跳转还是直接跳转指令，均可以在EXE阶段计算出分支指令的实际跳转地址，因此可以将该阶段的分支指令信息发送给BPU模块进行分支指令信息的更新，包括是否实际跳转、实际跳转地址、跳转类型、预测情况。BranchCond只能给出方向预测的正确性，而在BPU模块内可以进行目标预测的正确性判断，若方向预测或者目标预测错误，则冲刷流水线并更新BPU内部维护的分支信息。

### 组成

BPU模块实现动态分支预测，采取两位饱和计数器PHT存储分支地址的历史跳转行为。使用直接映射cache实现BTB用于存储分支指令的类型、跳转地址、指令地址tag。使用跳转队列QUEUE记录历史跳转地址。

### 方向预测

每一条分支指令的方向预测由两位饱和计数器给出，状态机在 

- Strongly not taken(00)
  
- Weakly not taken(01)
  
- Weakly taken(10)
  
- Strongly taken(11) 
  
之间变化，当收到执行阶段给出的分支指令的跳转情况更新相应状态机。

### 目标预测

每一条分支指令的目标预测由BTB缓存给出。在送回取值阶段的当前周期指令组中若有跳转的分支指令，则将其跳转目标地址压入跳转队列中，在该条指令运行到流水线执行阶段时将信息送回BPU，比较实际跳转地址和跳转队列队首地址，若不一致则说明预测地址错误，需要冲刷流水线并将新的跳转信息写入BTB。当出现方向预测错误或者地址跳转错误时也需要刷新跳转队列。